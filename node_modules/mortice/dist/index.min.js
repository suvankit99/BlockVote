(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Mortice = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Mortice=(()=>{var Ae=Object.create;var N=Object.defineProperty;var We=Object.getOwnPropertyDescriptor;var Me=Object.getOwnPropertyNames;var Se=Object.getPrototypeOf,Ne=Object.prototype.hasOwnProperty;var Ke=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),qe=(r,e)=>{for(var t in e)N(r,t,{get:e[t],enumerable:!0})},me=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Me(e))!Ne.call(r,i)&&i!==t&&N(r,i,{get:()=>e[i],enumerable:!(n=We(e,i))||n.enumerable});return r};var ze=(r,e,t)=>(t=r!=null?Ae(Se(r)):{},me(e||!r||!r.__esModule?N(t,"default",{value:r,enumerable:!0}):t,r)),De=r=>me(N({},"__esModule",{value:!0}),r);var pe=Ke((He,B)=>{"use strict";var Fe=Object.prototype.hasOwnProperty,p="~";function Q(){}Object.create&&(Q.prototype=Object.create(null),new Q().__proto__||(p=!1));function $e(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function _e(r,e,t,n,i){if(typeof t!="function")throw new TypeError("The listener must be a function");var u=new $e(t,n||r,i),o=p?p+e:e;return r._events[o]?r._events[o].fn?r._events[o]=[r._events[o],u]:r._events[o].push(u):(r._events[o]=u,r._eventsCount++),r}function K(r,e){--r._eventsCount===0?r._events=new Q:delete r._events[e]}function _(){this._events=new Q,this._eventsCount=0}_.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)Fe.call(t,n)&&e.push(p?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};_.prototype.listeners=function(e){var t=p?p+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,u=n.length,o=new Array(u);i<u;i++)o[i]=n[i].fn;return o};_.prototype.listenerCount=function(e){var t=p?p+e:e,n=this._events[t];return n?n.fn?1:n.length:0};_.prototype.emit=function(e,t,n,i,u,o){var l=p?p+e:e;if(!this._events[l])return!1;var s=this._events[l],d=arguments.length,f,c;if(s.fn){switch(s.once&&this.removeListener(e,s.fn,void 0,!0),d){case 1:return s.fn.call(s.context),!0;case 2:return s.fn.call(s.context,t),!0;case 3:return s.fn.call(s.context,t,n),!0;case 4:return s.fn.call(s.context,t,n,i),!0;case 5:return s.fn.call(s.context,t,n,i,u),!0;case 6:return s.fn.call(s.context,t,n,i,u,o),!0}for(c=1,f=new Array(d-1);c<d;c++)f[c-1]=arguments[c];s.fn.apply(s.context,f)}else{var y=s.length,O;for(c=0;c<y;c++)switch(s[c].once&&this.removeListener(e,s[c].fn,void 0,!0),d){case 1:s[c].fn.call(s[c].context);break;case 2:s[c].fn.call(s[c].context,t);break;case 3:s[c].fn.call(s[c].context,t,n);break;case 4:s[c].fn.call(s[c].context,t,n,i);break;default:if(!f)for(O=1,f=new Array(d-1);O<d;O++)f[O-1]=arguments[O];s[c].fn.apply(s[c].context,f)}}return!0};_.prototype.on=function(e,t,n){return _e(this,e,t,n,!1)};_.prototype.once=function(e,t,n){return _e(this,e,t,n,!0)};_.prototype.removeListener=function(e,t,n,i){var u=p?p+e:e;if(!this._events[u])return this;if(!t)return K(this,u),this;var o=this._events[u];if(o.fn)o.fn===t&&(!i||o.once)&&(!n||o.context===n)&&K(this,u);else{for(var l=0,s=[],d=o.length;l<d;l++)(o[l].fn!==t||i&&!o[l].once||n&&o[l].context!==n)&&s.push(o[l]);s.length?this._events[u]=s.length===1?s[0]:s:K(this,u)}return this};_.prototype.removeAllListeners=function(e){var t;return e?(t=p?p+e:e,this._events[t]&&K(this,t)):(this._events=new Q,this._eventsCount=0),this};_.prototype.off=_.prototype.removeListener;_.prototype.addListener=_.prototype.on;_.prefixed=p;_.EventEmitter=_;typeof B<"u"&&(B.exports=_)});var Be={};qe(Be,{default:()=>ke});var U=ze(pe(),1);var C=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},H=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},ve=r=>globalThis.DOMException===void 0?new H(r):new DOMException(r),Ee=r=>{let e=r.reason===void 0?ve("This operation was aborted."):r.reason;return e instanceof Error?e:ve(e)};function J(r,e,t,n){let i,u=new Promise((o,l)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(e===Number.POSITIVE_INFINITY){o(r);return}if(n={customTimers:{setTimeout,clearTimeout},...n},n.signal){let{signal:s}=n;s.aborted&&l(Ee(s)),s.addEventListener("abort",()=>{l(Ee(s))})}i=n.customTimers.setTimeout.call(void 0,()=>{if(typeof t=="function"){try{o(t())}catch(f){l(f)}return}let s=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,d=t instanceof Error?t:new C(s);typeof r.cancel=="function"&&r.cancel(),l(d)},e),(async()=>{try{o(await r)}catch(s){l(s)}finally{n.customTimers.clearTimeout.call(void 0,i)}})()});return u.clear=()=>{clearTimeout(i),i=void 0},u}function X(r,e,t){let n=0,i=r.length;for(;i>0;){let u=Math.trunc(i/2),o=n+u;t(r[o],e)<=0?(n=++o,i-=u+1):i=u}return n}var L=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},g,Z=class{constructor(){g.set(this,[])}enqueue(e,t){t={priority:0,...t};let n={priority:t.priority,run:e};if(this.size&&L(this,g,"f")[this.size-1].priority>=t.priority){L(this,g,"f").push(n);return}let i=X(L(this,g,"f"),n,(u,o)=>o.priority-u.priority);L(this,g,"f").splice(i,0,n)}dequeue(){let e=L(this,g,"f").shift();return e?.run}filter(e){return L(this,g,"f").filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return L(this,g,"f").length}};g=new WeakMap;var we=Z;var h=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},a=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},m,A,W,T,G,M,q,w,k,v,z,E,S,P,D,ye,ge,be,Pe,Te,F,j,ee,V,xe,$,Y=class extends Error{},te=class extends U.default{constructor(e){var t,n,i,u;if(super(),m.add(this),A.set(this,void 0),W.set(this,void 0),T.set(this,0),G.set(this,void 0),M.set(this,void 0),q.set(this,0),w.set(this,void 0),k.set(this,void 0),v.set(this,void 0),z.set(this,void 0),E.set(this,0),S.set(this,void 0),P.set(this,void 0),D.set(this,void 0),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:we,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(u=(i=e.interval)===null||i===void 0?void 0:i.toString())!==null&&u!==void 0?u:""}\` (${typeof e.interval})`);h(this,A,e.carryoverConcurrencyCount,"f"),h(this,W,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,"f"),h(this,G,e.intervalCap,"f"),h(this,M,e.interval,"f"),h(this,v,new e.queueClass,"f"),h(this,z,e.queueClass,"f"),this.concurrency=e.concurrency,this.timeout=e.timeout,h(this,D,e.throwOnTimeout===!0,"f"),h(this,P,e.autoStart===!1,"f")}get concurrency(){return a(this,S,"f")}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);h(this,S,e,"f"),a(this,m,"m",V).call(this)}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:a(this,D,"f"),...t},new Promise((n,i)=>{a(this,v,"f").enqueue(async()=>{var u,o,l;h(this,E,(o=a(this,E,"f"),o++,o),"f"),h(this,T,(l=a(this,T,"f"),l++,l),"f");try{if(!((u=t.signal)===null||u===void 0)&&u.aborted)throw new Y("The task was aborted.");let s=e({signal:t.signal});t.timeout&&(s=J(Promise.resolve(s),t.timeout)),t.signal&&(s=Promise.race([s,a(this,m,"m",xe).call(this,t.signal)]));let d=await s;n(d),this.emit("completed",d)}catch(s){if(s instanceof C&&!t.throwOnTimeout){n();return}i(s),this.emit("error",s)}finally{a(this,m,"m",be).call(this)}},t),this.emit("add"),a(this,m,"m",F).call(this)})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return a(this,P,"f")?(h(this,P,!1,"f"),a(this,m,"m",V).call(this),this):this}pause(){h(this,P,!0,"f")}clear(){h(this,v,new(a(this,z,"f")),"f")}async onEmpty(){a(this,v,"f").size!==0&&await a(this,m,"m",$).call(this,"empty")}async onSizeLessThan(e){a(this,v,"f").size<e||await a(this,m,"m",$).call(this,"next",()=>a(this,v,"f").size<e)}async onIdle(){a(this,E,"f")===0&&a(this,v,"f").size===0||await a(this,m,"m",$).call(this,"idle")}get size(){return a(this,v,"f").size}sizeBy(e){return a(this,v,"f").filter(e).length}get pending(){return a(this,E,"f")}get isPaused(){return a(this,P,"f")}};A=new WeakMap,W=new WeakMap,T=new WeakMap,G=new WeakMap,M=new WeakMap,q=new WeakMap,w=new WeakMap,k=new WeakMap,v=new WeakMap,z=new WeakMap,E=new WeakMap,S=new WeakMap,P=new WeakMap,D=new WeakMap,m=new WeakSet,ye=function(){return a(this,W,"f")||a(this,T,"f")<a(this,G,"f")},ge=function(){return a(this,E,"f")<a(this,S,"f")},be=function(){var e;h(this,E,(e=a(this,E,"f"),e--,e),"f"),a(this,m,"m",F).call(this),this.emit("next")},Pe=function(){a(this,m,"m",ee).call(this),a(this,m,"m",j).call(this),h(this,k,void 0,"f")},Te=function(){let e=Date.now();if(a(this,w,"f")===void 0){let t=a(this,q,"f")-e;if(t<0)h(this,T,a(this,A,"f")?a(this,E,"f"):0,"f");else return a(this,k,"f")===void 0&&h(this,k,setTimeout(()=>{a(this,m,"m",Pe).call(this)},t),"f"),!0}return!1},F=function(){if(a(this,v,"f").size===0)return a(this,w,"f")&&clearInterval(a(this,w,"f")),h(this,w,void 0,"f"),this.emit("empty"),a(this,E,"f")===0&&this.emit("idle"),!1;if(!a(this,P,"f")){let e=!a(this,m,"a",Te);if(a(this,m,"a",ye)&&a(this,m,"a",ge)){let t=a(this,v,"f").dequeue();return t?(this.emit("active"),t(),e&&a(this,m,"m",j).call(this),!0):!1}}return!1},j=function(){a(this,W,"f")||a(this,w,"f")!==void 0||(h(this,w,setInterval(()=>{a(this,m,"m",ee).call(this)},a(this,M,"f")),"f"),h(this,q,Date.now()+a(this,M,"f"),"f"))},ee=function(){a(this,T,"f")===0&&a(this,E,"f")===0&&a(this,w,"f")&&(clearInterval(a(this,w,"f")),h(this,w,void 0,"f")),h(this,T,a(this,A,"f")?a(this,E,"f"):0,"f"),a(this,m,"m",V).call(this)},V=function(){for(;a(this,m,"m",F).call(this););},xe=async function(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(new Y("The task was aborted."))},{once:!0})})},$=async function(e,t){return new Promise(n=>{let i=()=>{t&&!t()||(this.off(e,i),n())};this.on(e,i)})};var re=te;var ne=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},ie=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},Le=r=>globalThis.DOMException===void 0?new ie(r):new DOMException(r),Ie=r=>{let e=r.reason===void 0?Le("This operation was aborted."):r.reason;return e instanceof Error?e:Le(e)};function se(r,e){let{milliseconds:t,fallback:n,message:i,customTimers:u={setTimeout,clearTimeout}}=e,o,s=new Promise((d,f)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:y}=e;y.aborted&&f(Ie(y)),y.addEventListener("abort",()=>{f(Ie(y))})}if(t===Number.POSITIVE_INFINITY){r.then(d,f);return}let c=new ne;o=u.setTimeout.call(void 0,()=>{if(n){try{d(n())}catch(y){f(y)}return}typeof r.cancel=="function"&&r.cancel(),i===!1?d():i instanceof Error?f(i):(c.message=i??`Promise timed out after ${t} milliseconds`,f(c))},t),(async()=>{try{d(await r)}catch(y){f(y)}})()}).finally(()=>{s.clear()});return s.clear=()=>{u.clearTimeout.call(void 0,o),o=void 0},s}var b={},R=r=>{r.addEventListener("message",e=>{R.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{R.dispatchEvent("message",r,e)})};R.addEventListener=(r,e)=>{b[r]==null&&(b[r]=[]),b[r].push(e)};R.removeEventListener=(r,e)=>{b[r]!=null&&(b[r]=b[r].filter(t=>t===e))};R.dispatchEvent=function(r,e,t){b[r]!=null&&b[r].forEach(n=>n(e,t))};var ae=R;var oe="lock:worker:request-read",ue="lock:worker:release-read",le="lock:master:grant-read",ce="lock:worker:request-write",fe="lock:worker:release-write",he="lock:master:grant-write";var Re=(r=21)=>Math.random().toString().substring(2);var Oe=(r,e,t,n,i)=>(u,o)=>{if(o.data.type!==t)return;let l={type:o.data.type,name:o.data.name,identifier:o.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:l.name,handler:async()=>{u.postMessage({type:i,name:l.name,identifier:l.identifier}),await new Promise(s=>{let d=f=>{if(f==null||f.data==null)return;let c={type:f.data.type,name:f.data.name,identifier:f.data.identifier};c.type===n&&c.identifier===l.identifier&&(u.removeEventListener("message",d),s())};u.addEventListener("message",d)})}}}))},Qe=(r,e,t,n)=>async()=>{let i=Re();return globalThis.postMessage({type:e,identifier:i,name:r}),new Promise(u=>{let o=l=>{if(l==null||l.data==null)return;let s={type:l.data.type,identifier:l.data.identifier};s.type===t&&s.identifier===i&&(globalThis.removeEventListener("message",o),u(()=>{globalThis.postMessage({type:n,identifier:i,name:r})}))};globalThis.addEventListener("message",o)})},Ge={singleProcess:!1},Ce=r=>{if(r=Object.assign({},Ge,r),!!globalThis.document||r.singleProcess){let t=new EventTarget;return ae.addEventListener("message",Oe(t,"requestReadLock",oe,ue,le)),ae.addEventListener("message",Oe(t,"requestWriteLock",ce,fe,he)),t}return{isWorker:!0,readLock:t=>Qe(t,oe,le,ue),writeLock:t=>Qe(t,ce,he,fe)}};var I={},x;async function de(r,e){let t,n=new Promise(i=>{t=i});return r.add(async()=>se((async()=>{await new Promise(i=>{t(()=>{i()})})})(),{milliseconds:e.timeout})),n}var Ve=(r,e)=>{if(x.isWorker===!0)return{readLock:x.readLock(r,e),writeLock:x.writeLock(r,e)};let t=new re({concurrency:1}),n;return{async readLock(){if(n!=null)return de(n,e);n=new re({concurrency:e.concurrency,autoStart:!1});let i=n,u=de(n,e);return t.add(async()=>{i.start(),await i.onIdle().then(()=>{n===i&&(n=null)})}),u},async writeLock(){return n=null,de(t,e)}}},Ye={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function ke(r){let e=Object.assign({},Ye,r);return x==null&&(x=Ce(e),x.isWorker!==!0&&(x.addEventListener("requestReadLock",t=>{I[t.data.name]!=null&&I[t.data.name].readLock().then(async n=>t.data.handler().finally(()=>{n()}))}),x.addEventListener("requestWriteLock",async t=>{I[t.data.name]!=null&&I[t.data.name].writeLock().then(async n=>t.data.handler().finally(()=>{n()}))}))),I[e.name]==null&&(I[e.name]=Ve(e.name,e)),I[e.name]}return De(Be);})();
return Mortice}));
